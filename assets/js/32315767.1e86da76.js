"use strict";(self.webpackChunknottes=self.webpackChunknottes||[]).push([[4078],{3905:(e,t,l)=>{l.d(t,{Zo:()=>u,kt:()=>k});var n=l(67294);function a(e,t,l){return t in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}function r(e,t){var l=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),l.push.apply(l,n)}return l}function i(e){for(var t=1;t<arguments.length;t++){var l=null!=arguments[t]?arguments[t]:{};t%2?r(Object(l),!0).forEach((function(t){a(e,t,l[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(l)):r(Object(l)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(l,t))}))}return e}function o(e,t){if(null==e)return{};var l,n,a=function(e,t){if(null==e)return{};var l,n,a={},r=Object.keys(e);for(n=0;n<r.length;n++)l=r[n],t.indexOf(l)>=0||(a[l]=e[l]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)l=r[n],t.indexOf(l)>=0||Object.prototype.propertyIsEnumerable.call(e,l)&&(a[l]=e[l])}return a}var s=n.createContext({}),p=function(e){var t=n.useContext(s),l=t;return e&&(l="function"==typeof e?e(t):i(i({},t),e)),l},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var l=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),m=p(l),k=a,c=m["".concat(s,".").concat(k)]||m[k]||d[k]||r;return l?n.createElement(c,i(i({ref:t},u),{},{components:l})):n.createElement(c,i({ref:t},u))}));function k(e,t){var l=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=l.length,i=new Array(r);i[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:a,i[1]=o;for(var p=2;p<r;p++)i[p]=l[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,l)}m.displayName="MDXCreateElement"},73389:(e,t,l)=>{l.r(t),l.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var n=l(87462),a=(l(67294),l(3905));const r={},i="Credential Stealers",o={unversionedId:"Year3/4101/13",id:"Year3/4101/13",title:"Credential Stealers",description:"Malware trying to steal credentials",source:"@site/docs/Year3/4101/13.md",sourceDirName:"Year3/4101",slug:"/Year3/4101/13",permalink:"/Year3/4101/13",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"year3",previous:{title:"Backdoors",permalink:"/Year3/4101/12"},next:{title:"Persistence",permalink:"/Year3/4101/14"}},s={},p=[{value:"Keyloggers",id:"keyloggers",level:2},{value:"User-Space Keyloggers",id:"user-space-keyloggers",level:2},{value:"Hooking Keyloggers",id:"hooking-keyloggers",level:2},{value:"Implementing",id:"implementing",level:3},{value:"Implementing a polling keylogger",id:"implementing-a-polling-keylogger",level:2},{value:"Identifying Keyloggers",id:"identifying-keyloggers",level:2},{value:"Windows Login",id:"windows-login",level:2},{value:"Gina Interception",id:"gina-interception",level:2},{value:"Hash Dumping",id:"hash-dumping",level:2}],u={toc:p};function d(e){let{components:t,...l}=e;return(0,a.kt)("wrapper",(0,n.Z)({},u,l,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"credential-stealers"},"Credential Stealers"),(0,a.kt)("p",null,"Malware trying to steal credentials"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"MFA makes them less useful (but still exploitable)"),(0,a.kt)("li",{parentName:"ul"},"Also other things that can act as a credential"),(0,a.kt)("li",{parentName:"ul"},"Particularly for cloud/web based services"),(0,a.kt)("li",{parentName:"ul"},"Often done by storing a session identifier in a cookie. Cookies are key-value pairs stored in your browser"),(0,a.kt)("li",{parentName:"ul"},"Can steal the file, and then impersonate the user")),(0,a.kt)("p",null,"Three general approaches"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Programs that wait for a user to login"),(0,a.kt)("li",{parentName:"ol"},"Programs that dump information stored in Windows"),(0,a.kt)("li",{parentName:"ol"},"Programs that log keystrokes")),(0,a.kt)("h2",{id:"keyloggers"},"Keyloggers"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Intercepting Windows login or hash duping will provide details of the username and password to log into the computer"),(0,a.kt)("li",{parentName:"ul"},"Potentially other computers on the network"),(0,a.kt)("li",{parentName:"ul"},"Will not provide details of logins for other resources"),(0,a.kt)("li",{parentName:"ul"},"Keylogging will capture all keys pressed"),(0,a.kt)("li",{parentName:"ul"},"This will capture any password typed into the system (and a lot more)"),(0,a.kt)("li",{parentName:"ul"},"Need to find the passwords"),(0,a.kt)("li",{parentName:"ul"},"Can be implemented in both kernel and user space"),(0,a.kt)("li",{parentName:"ul"},"Kernel-based keyloggers are difficult to detect with user-mode applications")),(0,a.kt)("h2",{id:"user-space-keyloggers"},"User-Space Keyloggers"),(0,a.kt)("p",null,"Windows API provides two ways to implement in user-space"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("em",{parentName:"li"},"Hooking")," - get Windows to notify the malware every time a key is pressed"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("em",{parentName:"li"},"Polling")," - Malware interrogates windows to see if a specific key is pressed")),(0,a.kt)("h2",{id:"hooking-keyloggers"},"Hooking Keyloggers"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Typically make use of ",(0,a.kt)("inlineCode",{parentName:"li"},"SetWindowsHookEx()")," - Allows you to monitor for various events"),(0,a.kt)("li",{parentName:"ul"},"Typically will include a ",(0,a.kt)("inlineCode",{parentName:"li"},".exe")," which will initiate the hook function"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},".dll")," to handle the logging"),(0,a.kt)("li",{parentName:"ul"},"Injected into other processes on the system")),(0,a.kt)("h3",{id:"implementing"},"Implementing"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Create a DLL that exports a ",(0,a.kt)("inlineCode",{parentName:"li"},"KeyboardProc")," or ",(0,a.kt)("inlineCode",{parentName:"li"},"LowLevelKeyboardProc")," call-back function"),(0,a.kt)("li",{parentName:"ul"},"Should call ",(0,a.kt)("inlineCode",{parentName:"li"},"CallNextHookEx()")," to ensure that the program still works as expected"),(0,a.kt)("li",{parentName:"ul"},"Load the library with ",(0,a.kt)("inlineCode",{parentName:"li"},"LoadLibraryA()")),(0,a.kt)("li",{parentName:"ul"},"Get the address of the function (",(0,a.kt)("inlineCode",{parentName:"li"},"GetProcAddress()"),")"),(0,a.kt)("li",{parentName:"ul"},"Call ",(0,a.kt)("inlineCode",{parentName:"li"},"SetWindowsHookEx()")," to hook the function in"),(0,a.kt)("li",{parentName:"ul"},"A ",(0,a.kt)("inlineCode",{parentName:"li"},"dwThreadID")," of zero will hook into all threads on the current desktop")),(0,a.kt)("h2",{id:"implementing-a-polling-keylogger"},"Implementing a polling keylogger"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Polling keyloggers are conceptually much simpler"),(0,a.kt)("li",{parentName:"ul"},"Make use of the ",(0,a.kt)("inlineCode",{parentName:"li"},"GetAsyncKeyState()")," API function"),(0,a.kt)("li",{parentName:"ul"},"Can also tell you if key was pressed last time ",(0,a.kt)("inlineCode",{parentName:"li"},"GetAsyncKeyState()")," was called"),(0,a.kt)("li",{parentName:"ul"},"Tests whether a specific key is pressed"),(0,a.kt)("li",{parentName:"ul"},"Can iterate through every key on the keyboard to test all of them to find which are pressed"),(0,a.kt)("li",{parentName:"ul"},"Check the state of Shift/Caps lock as well"),(0,a.kt)("li",{parentName:"ul"},"Test each key on keyboard to see if pressed, sleep for a bit, repeat")),(0,a.kt)("h2",{id:"identifying-keyloggers"},"Identifying Keyloggers"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Polling keyloggers will often leave tell-tale signs in the strings of the program"),(0,a.kt)("li",{parentName:"ul"},"If the malware wants to log all keys, then it will need to have names for keys "),(0,a.kt)("li",{parentName:"ul"},"Follow the strings back to the code that implements it")),(0,a.kt)("h2",{id:"windows-login"},"Windows Login"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Allows you to extend the login mechanism"),(0,a.kt)("li",{parentName:"ul"},"In XP done by Graphical Identification and Authentication (GINA)"),(0,a.kt)("li",{parentName:"ul"},"Later uses Credential Providers"),(0,a.kt)("li",{parentName:"ul"},"Possible to use these to install credential stealers by pretending to be a provider")),(0,a.kt)("h2",{id:"gina-interception"},"Gina Interception"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"fsgina.dll")," exports the same function that ",(0,a.kt)("inlineCode",{parentName:"li"},"msgina.dll")," exported"),(0,a.kt)("li",{parentName:"ul"},"Most functions get called directly, apart from ",(0,a.kt)("inlineCode",{parentName:"li"},"WlxLoggedOutSAS()")," - password would be copied")),(0,a.kt)("h2",{id:"hash-dumping"},"Hash Dumping"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Aim to copy the password hashes off the system"),(0,a.kt)("li",{parentName:"ul"},"Often get the equivalent"),(0,a.kt)("li",{parentName:"ul"},"Source code for several tools available, often used by malware authors"),(0,a.kt)("li",{parentName:"ul"},"Recognised by antivirus software")))}d.isMDXComponent=!0}}]);